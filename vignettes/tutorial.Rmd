---
title: "tutorial"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
# library(knitr)
# knit("vignettes/tutorial.Rmd", "../rollup/README.md")
```
## rollup Tutorial

### Import Library and Data
```{r setup}
library(rollup)
data("web_service_data")
web_service_data %>% head
```

### grouping_sets
- group by multiple columns in one line

```{r}
# avg_pv_cnt group by (gender, age, (gender, age))
web_service_data %>% filter(date_id == '2024-06-30' & gender != "N") %>% 
  group_by(gender, age) %>% grouping_sets('gender', 'age', c('gender','age')) %>% 
  summarize(avg_pv_cnt = mean(page_view_cnt))

# avg_pv_cnt group by ((gender, age, product_view_cnt_cat), product_view_cnt_cat)
web_service_data %>% filter(date_id == '2024-06-30' & gender != "N") %>% 
  group_by(gender, age, product_view_cnt_cat) %>% grouping_sets('product_view_cnt_cat', c('product_view_cnt_cat', 'gender','age')) %>% 
  summarize(avg_pv_cnt = mean(page_view_cnt)) %>% pivot_wider(names_from = product_view_cnt_cat, values_from = avg_pv_cnt)
```
### with_cube
- simply add all possible combinations of grouping variables
- easily add row sum and column sum in cross table
```{r}
web_service_data %>% filter(date_id == '2024-06-30' & gender != "N") %>% 
  group_by(gender, age) %>% with_cube() %>% 
  summarize(avg_pv_cnt = mean(page_view_cnt)) %>% pivot_wider(names_from = age, values_from = avg_pv_cnt)

# with_cube equals to grouping_sets with all possible combinations
# web_service_data %>% filter(date_id == '2024-06-30' & gender != "N") %>% 
#   group_by(gender, age) %>% grouping_sets("gender","age",c("gender","age"), NA) %>% 
#   summarize(avg_pv_cnt = mean(page_view_cnt)) %>% pivot_wider(names_from = age, values_from = avg_pv_cnt)
```
### with_rollup
- add all possible combinations of grouping variables in descending order
- easily calculate group sum and total sum (DAU and MAU in this example)
```{r}
web_service_data %>% 
  group_by(date_id) %>% with_rollup() %>% 
  summarize(user_cnt = n_distinct(if_else(page_view_cnt > 0, id, NA)))

# with_rollup equals to grouping_sets with all possible combinations in descending order
# web_service_data %>%
#   group_by(date_id) %>% grouping_sets("date_id", NA) %>%
#   summarize(user_cnt = n_distinct(if_else(page_view_cnt > 0, id, NA)))
```


### appendix) sparklyr
- grouping_sets, with_cube and with_rollup are also available in sparklyr
```{r}
# example usage with Spark DataFrame
library(sparklyr)
sc <- spark_connect(master = "local")
sdf <- copy_to(sc, web_service_data, "web_service_data", overwrite = TRUE)

# grouping_sets on spark dataframe
sdf %>%
  group_by(gender, age) %>%
  with_rollup() %>%
  summarize(avg_pv_cnt = mean(page_view_cnt)) %>% collect()
```
